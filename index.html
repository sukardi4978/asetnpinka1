<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Cek Aset Non Produksi PT INKA</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&family=Roboto+Mono&display=swap" rel="stylesheet">
<style>
  body{margin:20px;font-family:'Roboto Condensed',Arial,sans-serif;text-align:center;}
  h2{margin:0 0 8px;}
  #runningText{margin:10px 0;font-size:14px;font-weight:500;color:#1a73e8;}
  #searchBox{padding:8px;font-size:16px;width:220px;}
  #searchButton{padding:8px 12px;cursor:pointer;}
  .hint{font-size:12px;color:#666;margin-top:6px;}
  #infoText{margin-top:10px;font-weight:500;}
  #output{margin:18px auto;text-align:left;display:inline-block;padding:12px;border-radius:6px;max-width:720px;min-width:320px;}
  .asset-row{display:grid;grid-template-columns:120px 8px 1fr;padding:4px 0;border-bottom:1px solid #ddd;column-gap:6px;}
  .asset-row:last-child{border-bottom:none;}
  .asset-label{font-weight:500;text-align:left;width:120px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
  .asset-sep{text-align:center;}
  .asset-value{white-space:pre-wrap;word-break:break-word;padding-left:2px;}
  #themeToggle{display:block;margin:10px auto 0 auto;padding:6px 12px;cursor:pointer;}
  body.light{background:#f8fbff;color:#222}
  body.dark{background:#121212;color:#eee}
  #output.light{background:#f8fbff;border:1px solid #ccc}
  #output.dark{background:#121212;border:1px solid #555}
</style>
</head>
<body>

<h2>Cek Data Aset</h2>
<h2>Cek Aset Non Produksi PT INKA Madiun</h2>

<marquee id="runningText" scrollamount="8"></marquee>

<div style="margin-top:10px;">
  <input id="searchBox" type="text" placeholder="Masukkan Nomor Aset..." list="assetList" autocomplete="off"/>
  <button id="searchButton">üîç</button>
  <datalist id="assetList"></datalist>
</div>
<div class="hint">Tekan Enter atau tombol üîç untuk mencari.</div>

<div id="infoText"></div>
<div id="output">Silakan ketik Nomor Aset‚Ä¶</div>
<button id="themeToggle">Tema Gelap</button>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTafvAiaKbaQt2RIboLf9nY6v8mltXLhSN4R-l-LZGFmic1p0-83knr-g-bFEoPDB8Rl2T661YdYFTj/pub?gid=1753334008&single=true&output=csv";
let assets = [];

function parseCSV(text) {
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/);
  const rows = lines.map(line => {
    const cells = [];
    let cur = '', inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1]==='"') { cur+='"'; i++; } else { inQuotes=!inQuotes; }
      } else if (ch===',' && !inQuotes) { cells.push(cur); cur=''; }
      else cur+=ch;
    }
    cells.push(cur);
    return cells.map(c => (c||'').toString().trim());
  });
  return rows;
}

function cleanRows(rows) {
  return rows.filter(r => r && r.join('').trim() && r.join('').trim()!=='1');
}

function hasLetter(s){ try { return /\p{L}/u.test(s); } catch { return /[A-Za-z]/.test(s); } }
function firstTextCell(row) { for (const c of row) if (c && hasLetter(c)) return c; for (const c of row) if (c) return c; return ''; }

function findR1R2(rows) {
  let r1=-1,r2=-1;
  rows.forEach((row,i)=>{
    if(row.some(c=>hasLetter(c))) {
      if(r1===-1) r1=i;
      else if(r2===-1) r2=i;
    }
  });
  if(r1===-1) r1=0;
  if(r2===-1) r2=Math.min(rows.length-1,r1+1);
  return [r1,r2];
}

async function loadSheet() {
  try {
    const res = await fetch(sheetUrl,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    let rows = parseCSV(text);
    rows = cleanRows(rows);
    if(!rows.length){
      document.getElementById('output').innerHTML='Sheet kosong atau tidak ter-publish.';
      return;
    }

    const [r1,r2] = findR1R2(rows);
    document.getElementById('infoText').textContent = firstTextCell(rows[r1]);
    document.getElementById('runningText').textContent = firstTextCell(rows[r2]);

    // Tentukan start data aset (baris setelah header)
    let start = Math.max(r1,r2)+1;

    assets = rows.slice(start).map(r=>({
      kode: r[0]||'',
      deskripsi: r[1]||'',
      kapitalisasi: r[2]||'',
      nilai: r[3]||'',
      opname: r[5]||'',
      lokasi: r[8]||'',
      detail: r[9]||'',
    })).filter(a=>a.kode);

    // isi datalist
    const dl = document.getElementById('assetList');
    dl.innerHTML='';
    assets.map(a=>a.kode).sort().forEach(k=>{
      const opt = document.createElement('option');
      opt.value=k;
      dl.appendChild(opt);
    });

    console.log('Data aset dimuat:', assets.length);
  } catch(err){
    document.getElementById('output').innerHTML='Gagal memuat data: '+err;
    console.error(err);
  }
}

function formatAsset(a){
  let nilai = a.nilai||'';
  if(!nilai) nilai='Rp. -';
  else if(!nilai.startsWith('Rp.')) nilai='Rp. '+nilai;
  const rows=[
    ['Nomor Aset',a.kode],
    ['Deskripsi',a.deskripsi],
    ['Kapitalisasi',a.kapitalisasi],
    ['Nilai Perolehan',nilai],
    ['Lokasi',a.lokasi],
    ['Detail Lokasi',a.detail],
    ['Opname Terakhir',a.opname]
  ];
  return rows.map(([label,val])=>`
    <div class="asset-row">
      <div class="asset-label">${label}</div><div class="asset-sep">:</div><div class="asset-value">${val||''}</div>
    </div>
  `).join('');
}

let selectNext=false;
function searchAsset(){
  const key = document.getElementById('searchBox').value.trim();
  const out = document.getElementById('output');
  if(!key) return out.innerHTML='Masukkan Nomor Aset terlebih dahulu.';
  let kode = key;
  if(/^\d{8}$/.test(kode)) kode+='-0';
  else if(/^\d{8}-$/.test(kode)) kode+='0';
  const f = assets.find(a=>a.kode===kode || a.kode===key);
  out.innerHTML = f ? formatAsset(f) : 'Data tidak ditemukan.';
  if(f) selectNext=true;
}

document.getElementById('searchBox').addEventListener('keydown', e=>{ if(e.key==='Enter') searchAsset(); });
document.getElementById('searchButton').addEventListener('click', searchAsset);
document.getElementById('searchBox').addEventListener('focus', function(){ if(selectNext){ this.select(); selectNext=false; } });

const themeToggle=document.getElementById('themeToggle');
function setTheme(t){
  document.body.className=t;
  document.getElementById('output').className=t;
  document.getElementById('searchBox').className=t;
  themeToggle.textContent = t==='light'?'Tema Gelap':'Tema Terang';
}
setTheme('light');
themeToggle.addEventListener('click',()=>setTheme(document.body.className==='light'?'dark':'light'));

loadSheet();
</script>
</body>
</html>
