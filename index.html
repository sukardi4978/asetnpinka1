<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Cek Aset Non Produksi PT INKA</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed&family=Roboto+Mono&display=swap" rel="stylesheet">
<style>
  body{margin:20px;text-align:center;font-family:'Roboto Condensed',Arial,sans-serif;}
  h2{margin:0 0 8px;}
  #searchBox{padding:8px;font-size:16px;width:180px;}
  #searchButton{padding:8px 12px;cursor:pointer;}
  .hint{font-size:12px;color:#666;margin-top:6px;}
  #infoText{margin-top:10px;font-weight:500;}
  #output{margin-top:12px;text-align:left;display:inline-block;padding:10px;border-radius:6px;max-width:95%;}
  /* grid */
  .asset-row{display:grid;grid-template-columns:120px 5px 1fr;padding:4px 0;border-bottom:1px solid #ddd;column-gap:6px;}
  .asset-row:last-child{border-bottom:none;}
  .asset-label{font-weight:500;text-align:left;width:120px;max-width:120px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
  .asset-sep{text-align:center;}
  .asset-value{white-space:pre-wrap;word-break:break-word;padding-left:2px;}
  #runningText{display:block;margin-top:8px;font-size:14px;}
  #themeToggle{margin-top:10px;padding:6px 12px;cursor:pointer;}
</style>
</head>
<body>
  <h2>Cek Data Aset</h2>

  <!-- running (akan diisi) -->
  <div id="runningText">Memuat running text‚Ä¶</div>

  <div style="margin-top:8px;">
    <input id="searchBox" type="text" placeholder="Masukkan Nomor Aset..." list="assetList" autocomplete="off"/>
    <button id="searchButton">üîç</button>
    <datalist id="assetList"></datalist>
  </div>
  <div class="hint">Tekan Enter atau tombol üîç untuk mencari.</div>

  <div id="infoText"></div>
  <div id="output">Silakan ketik Nomor Aset‚Ä¶</div>

  <button id="themeToggle">Tema Gelap</button>

<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTafvAiaKbaQt2RIboLf9nY6v8mltXLhSN4R-l-LZGFmic1p0-83knr-g-bFEoPDB8Rl2T661YdYFTj/pub?gid=1753334008&single=true&output=csv";

let assets = [];

// CSV parser (meng-handle quotes)
function parseCSV(text){
  // remove BOM
  text = text.replace(/^\uFEFF/, '');
  const lines = text.split(/\r?\n/);
  const rows = lines.map(line=>{
    const cells=[]; let cur="", inQuotes=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if(ch === ',' && !inQuotes){ cells.push(cur); cur = ''; }
      else { cur += ch; }
    }
    cells.push(cur);
    return cells.map(c => c.replace(/^"|"$/g,''));
  });
  return rows;
}

// Buang baris kosong atau baris yang cuma "1"
function cleanRows(rows){
  return rows.filter(r=>{
    const joined = (r||[]).join('').trim();
    if(!joined) return false;
    if(joined === '1') return false;
    return true;
  });
}

// cari kolom terbaik untuk R1/R2: prioritas [17, 0]
function pickColForRow(row){
  if(!row) return 0;
  if(row[17] && row[17].toString().trim() !== '') return 17;
  if(row[0] && row[0].toString().trim() !== '') return 0;
  // fallback: cari first non-empty column
  for(let i=0;i<row.length;i++){ if(row[i] && row[i].toString().trim() !== '') return i; }
  return 0;
}

function safeCell(rows, r, c){
  if(!rows[r] || typeof rows[r][c] === 'undefined') return '';
  const t = String(rows[r][c]||'').trim();
  if(t === '1') return '';
  return t;
}

async function loadSheet(){
  try{
    document.getElementById('infoText').textContent = 'Memuat data...';
    const res = await fetch(sheetUrl, {cache: "no-store"});
    if(!res.ok) throw new Error('HTTP '+res.status);
    let text = await res.text();
    const rowsParsed = parseCSV(text);
    const rows = cleanRows(rowsParsed);

    console.log('CSV rows parsed:', rowsParsed.length, 'after clean:', rows.length);

    if(rows.length === 0){
      document.getElementById('infoText').textContent = 'Tidak ada data di sheet (periksa publish/link).';
      document.getElementById('runningText').textContent = '';
      document.getElementById('output').innerHTML = 'Gagal memuat data aset ‚Äî sheet kosong.';
      return;
    }

    // tentukan kolom R1 & R2
    const r1col = pickColForRow(rows[0]);
    const r2col = pickColForRow(rows[1] || rows[0]);

    const r1 = safeCell(rows, 0, r1col) || '';
    const r2 = safeCell(rows, 1, r2col) || '';

    // tampilkan (fallback text jika kosong)
    document.getElementById('infoText').textContent = r1 || '';
    document.getElementById('runningText').textContent = r2 || '';

    // cari indeks baris mulai data aset:
    // cari baris pertama yang punya kode aset di kolom 4 (index 4)
    let startIndex = 2;
    while(startIndex < rows.length && !(rows[startIndex] && rows[startIndex][4] && rows[startIndex][4].toString().trim())) startIndex++;
    console.log('Detected data start index:', startIndex);

    if(startIndex >= rows.length){
      // tidak ada data aset
      document.getElementById('output').innerHTML = 'Data aset tidak ditemukan pada sheet. (startIndex='+startIndex+')';
      return;
    }

    // buat array assets dari startIndex sampai akhir
    assets = rows.slice(startIndex).map(r => ({
      kode: (r[4]||'').toString().trim(),
      deskripsi: r[5]||'',
      kapitalisasi: r[6]||'',
      nilai: r[19]||'',
      opname: r[10]||r[9]||'',
      lokasi: r[13]||'',
      detail: r[14]||'',
      kondisi: r[15]||'',
      catatan: (r[16] && r[16].toString().trim()) ? r[16] : (r[21]||'')
    })).filter(a => a.kode);

    console.log('Assets loaded:', assets.length, assets.slice(0,2));
    if(assets.length === 0){
      document.getElementById('output').innerHTML = 'Tidak ada baris aset valid (periksa kolom Kode Aset di sheet).';
      return;
    }

    // isi datalist
    const dl = document.getElementById('assetList');
    dl.innerHTML = '';
    assets.map(a => a.kode).sort((a,b)=>a.localeCompare(b)).slice(0,5000).forEach(k=>{
      const opt = document.createElement('option'); opt.value = k; dl.appendChild(opt);
    });

    document.getElementById('infoText').textContent = r1 || '';
    // jika running text kosong berikan default singkat
    if(!r2) document.getElementById('runningText').textContent = '';
    else document.getElementById('runningText').textContent = r2;

  } catch(err){
    console.error('loadSheet error', err);
    document.getElementById('output').innerHTML = 'Gagal memuat data: ' + err;
    document.getElementById('infoText').textContent = '';
    document.getElementById('runningText').textContent = '';
  }
}

function formatAsset(a){
  let nilai = (a.nilai||'').toString().trim();
  if(!nilai) nilai = 'Rp. -'; else if(!nilai.startsWith('Rp.')) nilai = 'Rp. '+nilai;
  const rows = [
    ['Nomor Aset', a.kode],
    ['Deskripsi', a.deskripsi],
    ['Kapitalisasi', a.kapitalisasi],
    ['Nilai Perolehan', nilai],
    ['Lokasi', a.lokasi],
    ['Detail Lokasi', a.detail],
    ['Opname Terakhir', a.opname],
    ['Kondisi', a.kondisi],
    ['Catatan', a.catatan]
  ];
  return rows.map(([label,val])=>`
    <div class="asset-row">
      <div class="asset-label">${label}</div>
      <div class="asset-sep">:</div>
      <div class="asset-value">${val||''}</div>
    </div>
  `).join('');
}

function searchAsset(){
  const out = document.getElementById('output');
  const key = document.getElementById('searchBox').value.trim();
  if(!key){ out.innerHTML = 'Masukkan Nomor Aset terlebih dahulu.'; return; }
  let kode = key;
  if(/^\d{8}$/.test(kode)) kode += '-0';
  else if(/^\d{8}-$/.test(kode)) kode += '0';
  const f = assets.find(a => a.kode === kode);
  out.innerHTML = f ? formatAsset(f) : 'Data tidak ditemukan.';
}

document.getElementById('searchBox').addEventListener('keydown', e=>{ if(e.key==='Enter') searchAsset(); });
document.getElementById('searchButton').addEventListener('click', searchAsset);

loadSheet(); // initial
</script>
</body>
</html>
